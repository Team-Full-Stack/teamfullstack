<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Implementing Robust API Rate Limiting with ASP.NET Core | Team Full Stack</title> <meta name="author" content="Team Full. Stack"> <meta name="description" content="Learn how to implement API rate limiting in an ASP.NET Core application to manage request rates and ensure fair usage."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/profile.jpeg?b6d31c5b86e524b5e43cba1d5ca33348"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://blog.teamfullstack.io//blog/2024/Api-Rate-Limit/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Implementing Robust API Rate Limiting with ASP.NET Core",
      "description": "Learn how to implement API rate limiting in an ASP.NET Core application to manage request rates and ensure fair usage.",
      "published": "August 8, 2024",
      "authors": [
        {
          "author": "Usman Jamil Bhatti",
          "authorURL": "https://github.com/usman-jamil",
          "affiliations": [
            {
              "name": "Allied Consultants",
              "url": ""
            }
          ]
        },
        {
          "author": "Sheikh Luqman",
          "authorURL": "https://github.com/luqmant51",
          "affiliations": [
            {
              "name": "Allied Consultants",
              "url": ""
            }
          ]
        },
        {
          "author": "Zuhaib Sohail",
          "authorURL": "https://github.com/ZuhaibSohail163",
          "affiliations": [
            {
              "name": "Allied Consultants",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Team Full Stack</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Implementing Robust API Rate Limiting with ASP.NET Core</h1> <p>Learn how to implement API rate limiting in an ASP.NET Core application to manage request rates and ensure fair usage.</p> </d-title><d-byline></d-byline><d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#introduction">Introduction</a></div> <div><a href="#implementing-rate-limiting">Implementing Rate Limiting</a></div> <ul> <li><a href="#configuration">Configuration</a></li> <li><a href="#rate-limiting-policies">Rate Limiting Policies</a></li> <li><a href="#handling-rate-limit-exceed">Handling Rate Limit Exceed</a></li> </ul> <div><a href="#conclusion">Conclusion</a></div> </nav> </d-contents> <h2 id="implementing-rate-limiting-in-aspnet-core">Implementing Rate Limiting in ASP.NET Core</h2> <h2 id="introduction">Introduction</h2> <p>In modern web applications, managing API request rates is crucial for maintaining performance and ensuring fair usage among users. Implementing rate limiting helps to prevent abuse, mitigate denial-of-service attacks, and ensure that your service remains reliable for all users. In this blog post, we’ll explore how to implement a robust API rate limiting system using ASP.NET Core.</p> <h2 id="what-is-rate-limiting">What is Rate Limiting?</h2> <p>Rate limiting is a technique used to control the number of requests a client can make to an API within a specified time frame. This is essential for preventing system overload, maintaining quality of service, and ensuring that no single client consumes too many resources, which could lead to degraded performance for others.</p> <h2 id="how-does-rate-limiting-work">How Does Rate Limiting Work?</h2> <p>Rate limiting can be implemented using various algorithms, each with its own approach to controlling the rate of requests. Common algorithms include:</p> <ul> <li> <strong>Token Bucket</strong>: Tokens are added to a bucket at a fixed rate, and each request consumes a token. If the bucket is empty, the request is denied or delayed.</li> <li> <strong>Leaky Bucket</strong>: Similar to Token Bucket, but with a focus on ensuring a steady outflow of requests, smoothing out bursts.</li> <li> <strong>Fixed Window</strong>: Counts the number of requests within a fixed time window (e.g., 1 minute) and enforces a limit.</li> <li> <strong>Sliding Window</strong>: Similar to Fixed Window, but the time window slides forward with each request, providing a more granular rate limit.</li> </ul> <h2 id="benefits-of-rate-limiting">Benefits of Rate Limiting</h2> <p>Implementing rate limiting provides several key benefits:</p> <ol> <li> <strong>Prevents Abuse</strong>: Ensures that no single client can overwhelm the API with too many requests.</li> <li> <strong>Improves Performance</strong>: Helps maintain consistent performance by controlling the load on the server.</li> <li> <strong>Enhances Security</strong>: Mitigates denial-of-service (DoS) attacks by limiting the rate of incoming requests.</li> <li> <strong>Ensures Fair Usage</strong>: Guarantees that resources are distributed fairly among users.</li> </ol> <h2 id="implementing-rate-limiting">Implementing Rate Limiting</h2> <p>To implement rate limiting in an ASP.NET Core application, follow these steps:</p> <h3 id="1-add-rate-limiting-services">1. Add Rate Limiting Services</h3> <p>First, you need to add and configure the rate limiting services in your <code class="language-plaintext highlighter-rouge">Program.cs</code> file:</p> <ul> <li>You can download code from this repository <a href="https://github.com/Luqmant51/RateLimit.Blog" rel="external nofollow noopener" target="_blank">Api Rate Limiting</a> </li> </ul> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="nf">AddRateLimiter</span><span class="p">(</span><span class="n">limiterOptions</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">limiterOptions</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"jwt"</span><span class="p">,</span> <span class="n">partitioner</span><span class="p">:</span> <span class="n">httpContext</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">accessToken</span> <span class="p">=</span> <span class="n">httpContext</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">IAuthenticateResultFeature</span><span class="p">&gt;()?</span>
                              <span class="p">.</span><span class="n">AuthenticateResult</span><span class="p">?.</span><span class="n">Properties</span><span class="p">?.</span><span class="nf">GetTokenValue</span><span class="p">(</span><span class="s">"access_token"</span><span class="p">)</span>
                          <span class="p">??</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(!</span><span class="n">StringValues</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">accessToken</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">RateLimitPartition</span><span class="p">.</span><span class="nf">GetTokenBucketLimiter</span><span class="p">(</span><span class="n">accessToken</span><span class="p">,</span> <span class="n">_</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="n">TokenBucketRateLimiterOptions</span>
                <span class="p">{</span>
                    <span class="n">TokenLimit</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span>
                    <span class="n">QueueProcessingOrder</span> <span class="p">=</span> <span class="n">QueueProcessingOrder</span><span class="p">.</span><span class="n">OldestFirst</span><span class="p">,</span>
                    <span class="n">QueueLimit</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
                    <span class="n">ReplenishmentPeriod</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">60</span><span class="p">),</span>
                    <span class="n">TokensPerPeriod</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span>
                    <span class="n">AutoReplenishment</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">RateLimitPartition</span><span class="p">.</span><span class="nf">GetTokenBucketLimiter</span><span class="p">(</span><span class="s">"Anon"</span><span class="p">,</span> <span class="n">_</span> <span class="p">=&gt;</span>
            <span class="k">new</span> <span class="n">TokenBucketRateLimiterOptions</span>
            <span class="p">{</span>
                <span class="n">TokenLimit</span> <span class="p">=</span> <span class="m">5</span><span class="p">,</span>
                <span class="n">QueueProcessingOrder</span> <span class="p">=</span> <span class="n">QueueProcessingOrder</span><span class="p">.</span><span class="n">OldestFirst</span><span class="p">,</span>
                <span class="n">QueueLimit</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
                <span class="n">ReplenishmentPeriod</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">60</span><span class="p">),</span>
                <span class="n">TokensPerPeriod</span> <span class="p">=</span> <span class="m">5</span><span class="p">,</span>
                <span class="n">AutoReplenishment</span> <span class="p">=</span> <span class="k">true</span>
            <span class="p">});</span>
    <span class="p">});</span>
    <span class="n">limiterOptions</span><span class="p">.</span><span class="n">OnRejected</span> <span class="p">=</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Lease</span><span class="p">.</span><span class="nf">TryGetMetadata</span><span class="p">(</span><span class="n">MetadataName</span><span class="p">.</span><span class="n">RetryAfter</span><span class="p">,</span> <span class="k">out</span> <span class="n">TimeSpan</span> <span class="n">retryAfter</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">context</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="n">RetryAfter</span> <span class="p">=</span> <span class="n">retryAfter</span><span class="p">.</span><span class="n">TotalSeconds</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">context</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="n">StatusCodes</span><span class="p">.</span><span class="n">Status429TooManyRequests</span><span class="p">;</span>
        <span class="n">context</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">WriteAsync</span><span class="p">(</span><span class="s">"Too many requests. Please try again later."</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">:</span> <span class="n">cancellationToken</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">ValueTask</span><span class="p">();</span>
    <span class="p">};</span>
<span class="p">});</span>
</code></pre></div></div> <h2 id="what-is-a-partitioned-rate-limiter">What is a Partitioned Rate Limiter?</h2> <p>A partitioned rate limiter allows you to apply different rate limiting policies based on specific characteristics of incoming requests, such as user identity, IP address, or API key. This approach enables you to tailor rate limits to different groups of users or request types.</p> <h3 id="how-partitioning-works"><code class="language-plaintext highlighter-rouge">How Partitioning Works</code></h3> <p>In the provided code example:</p> <ul> <li> <p>Partitioning by Access Token:</p> <ul> <li>If a request contains an access token, a specific rate limiting policy is applied based on that token (e.g., 10 requests per minute).</li> <li>If no token is present (anonymous request), a different policy is applied (e.g., 5 requests per minute).</li> </ul> </li> <li>Rate Limiting Policy: <ul> <li>Each partition has its own <code class="language-plaintext highlighter-rouge">TokenBucketLimiterOptions</code>, specifying the number of allowed requests, replenishment rate, and other settings.</li> </ul> </li> <li>Handling Rate Limit Exceed: <ul> <li>When a rate limit is exceeded, the OnRejected callback sends a 429 Too Many Requests response, possibly including a Retry-After header.</li> </ul> </li> <li>Benefits of Partitioned Rate Limiting <ul> <li> <strong>Customization</strong>: Custom rate limits for different user groups or request types.</li> <li> <strong>Fairness</strong>: Ensures resource distribution is fair among users.</li> <li> <strong>Scalability</strong>: Helps in scaling rate limiting strategies as your application grows.</li> </ul> </li> </ul> <p>This approach is particularly useful in scenarios where different users or client types require different levels of access, ensuring that your API remains responsive and reliable for all users.</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/2024-8-8-Api-Rate-Limit.bib"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Team Full. Stack. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>